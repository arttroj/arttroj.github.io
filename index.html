<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dotazník Školy · V2</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    /* ========================
       THEME & RESET
    =========================*/
    :root {
      --bg-1: #0e0e13;
      --bg-2: #171821;
      --card: rgba(36, 37, 50, 0.55);
      --card-border: rgba(187, 134, 252, 0.35);
      --txt: #eef1ff;
      --muted: #b6b9d6;
      --primary: #bb86fc;
      --primary-2: #ff79c6;
      --accent: #50fa7b;
      --danger: #ff5555;
      --shadow: 0 10px 40px rgba(0, 0, 0, 0.55);
      --radius-lg: 20px;
      --radius-md: 14px;
      --radius-sm: 10px;
      --focus-ring: 0 0 0 3px rgba(187, 134, 252, 0.45);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--txt);
      background: radial-gradient(1200px 800px at 15% 10%, #2a1a48 0%, transparent 60%),
                  radial-gradient(1000px 700px at 85% 90%, #143c3c 0%, transparent 60%),
                  linear-gradient(135deg, var(--bg-1), var(--bg-2));
      min-height: 100dvh; /* mobile-safe */
      display: grid;
      place-items: center;
      overflow-x: hidden;
    }

    /* Decorative animated blobs */
    .bg-blob {
      position: fixed;
      inset: -10% -10% auto auto;
      width: 42vmax; height: 42vmax;
      filter: blur(60px);
      opacity: .15;
      background: conic-gradient(from 90deg, var(--primary), var(--primary-2), var(--accent));
      border-radius: 50%;
      animation: spin 30s linear infinite;
      z-index: 0;
      pointer-events: none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ========================
       POPUP (WELCOME)
    =========================*/
    .popup-overlay {
      position: fixed; inset: 0;
      display: grid; place-items: center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      opacity: 0; pointer-events: none;
      transition: opacity .4s ease;
      z-index: 50;
    }
    .popup-overlay.active { opacity: 1; pointer-events: auto; }

    .popup {
      width: min(92vw, 560px);
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 28px 26px;
      transform: translateY(12px) scale(.98);
      animation: popupIn .5s ease forwards;
    }
    @keyframes popupIn {
      to { transform: translateY(0) scale(1); opacity: 1; }
    }
    .popup h2 { margin: 0 0 10px; color: var(--primary); font-weight: 700; letter-spacing: .2px; }
    .popup p  { margin: 0 0 18px; color: var(--muted); line-height: 1.55; }
    .btn {
      appearance: none; border: 0; cursor: pointer;
      color: white; font-weight: 700; letter-spacing: .3px;
      background: linear-gradient(90deg, var(--primary), var(--primary-2), var(--accent));
      background-size: 300% 100%;
      padding: 12px 18px; border-radius: var(--radius-sm);
      box-shadow: 0 6px 22px rgba(187,134,252,.25);
      transition: transform .15s ease, filter .2s ease;
    }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px) scale(.99); }

    /* ========================
       CONTAINER & HEADER
    =========================*/
    .container {
      position: relative; z-index: 1;
      width: min(94vw, 760px);
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 28px clamp(18px, 4vw, 36px) 26px;
      display: none; /* shown after popup close */
    }

    header.hero {
      display: flex; align-items: center; gap: 14px;
      margin-bottom: 16px;
    }
    .logo {
      width: 44px; height: 44px; border-radius: 12px;
      display: grid; place-items: center;
      background: radial-gradient(60% 60% at 30% 30%, rgba(255,255,255,.17), rgba(255,255,255,.02)),
                  linear-gradient(135deg, #3b246a, #1f3f3a);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .logo svg { width: 26px; height: 26px; }

    h1.title { margin: 0; font-size: clamp(20px, 2.2vw, 26px); color: var(--txt); }
    .subtitle { color: var(--muted); font-size: .96rem; }

    /* ========================
       STEPPER + PROGRESS
    =========================*/
    .progress-wrap { margin: 18px 0 22px; }
    .progress-container {
      width: 100%; height: 12px; border-radius: 999px; overflow: hidden;
      background: rgba(255,255,255,.08);
    }
    .progress-bar {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--primary), var(--primary-2), var(--accent));
      background-size: 300% 100%;
      animation: gradientMove 4s linear infinite;
      transition: width .35s ease;
    }
    @keyframes gradientMove { from { background-position: 0% 50%; } to { background-position: 100% 50%; } }

    .stepper { display: flex; gap: 10px; margin-top: 12px; }
    .step-dot {
      width: 12px; height: 12px; border-radius: 50%;
      background: rgba(255,255,255,.15);
      outline: 1px solid rgba(255,255,255,.08);
      transition: transform .2s ease, background .2s ease;
    }
    .step-dot.active { background: var(--primary); transform: scale(1.15); }

    /* ========================
       FORM
    =========================*/
    form { display: grid; gap: 10px; }
    .form-step { display: none; animation: fadeInStep .45s ease; }
    .form-step.active { display: grid; gap: 14px; }
    @keyframes fadeInStep { from { opacity: 0; transform: translateY(10px);} to {opacity:1; transform:none;} }

    label { font-weight: 700; letter-spacing: .2px; margin-top: 8px; }
    .hint { color: var(--muted); font-size: .9rem; }

    input[type="number"], textarea, select {
      width: 100%;
      background: rgba(10,10,10,.45);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--txt);
      border-radius: var(--radius-sm);
      padding: 12px 12px;
      outline: none;
      transition: box-shadow .2s ease, transform .12s ease, border-color .2s ease;
    }
    textarea { min-height: 120px; resize: vertical; }
    input:focus, textarea:focus, select:focus {
      box-shadow: var(--focus-ring);
      border-color: var(--primary);
      transform: translateY(-1px);
    }

    /* Radios as segmented cards */
    .radio-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 6px; }
    .radio-card {
      position: relative; border-radius: var(--radius-sm);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(10,10,10,.45);
      padding: 12px; text-align: center; font-weight: 700; cursor: pointer;
      user-select: none; transition: transform .1s ease, border-color .2s ease, background .2s ease;
    }
    .radio-card:hover { transform: translateY(-1px); border-color: var(--primary); }
    .radio-card input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .radio-card:has(input:checked) {
      background: linear-gradient(180deg, rgba(187,134,252,.18), rgba(187,134,252,.08));
      border-color: var(--primary);
      box-shadow: 0 6px 22px rgba(187,134,252,.15);
    }

    /* NAV BUTTONS */
    .navigation-buttons { display: flex; gap: 10px; justify-content: space-between; margin-top: 8px; }
    .btn-secondary {
      background: rgba(255,255,255,.08); color: var(--txt);
      border: 1px solid rgba(255,255,255,.12);
    }

    .btn[disabled] { opacity: .6; cursor: not-allowed; filter: grayscale(.2); }

    /* TOAST */
    .toast { position: fixed; bottom: 18px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: rgba(30,30,45,.9); color: var(--txt); border: 1px solid rgba(255,255,255,.12);
      padding: 10px 14px; border-radius: 999px; opacity: 0; transition: opacity .3s ease, transform .3s ease; z-index: 40; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* SUCCESS MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: grid; place-items: center; z-index: 60; opacity: 0; pointer-events: none; transition: opacity .3s ease; }
    .modal-overlay.show { opacity: 1; pointer-events: auto; }
    .modal { width: min(92vw, 520px); background: var(--card); border: 1px solid var(--card-border); border-radius: var(--radius-lg); box-shadow: var(--shadow); padding: 24px; text-align: center; }
    .checkmark { width: 70px; height: 70px; border-radius: 50%; display: grid; place-items: center; margin: 6px auto 12px; background: radial-gradient(60% 60% at 30% 30%, rgba(255,255,255,.18), rgba(255,255,255,.03)), linear-gradient(135deg, #2e6a4a, #243b55); box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); }

    /* ACCESSIBILITY */
    .sr-only { position: absolute; width: 1px; height: 1px; margin: -1px; border: 0; padding: 0; clip: rect(0 0 0 0); overflow: hidden; }

    /* MOBILE */
    @media (max-width: 600px) {
      .radio-group { grid-template-columns: 1fr 1fr; }
      .container { padding: 20px 16px 18px; }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>
  <div class="bg-blob" aria-hidden="true"></div>

  <!-- Welcome Popup -->
  <div class="popup-overlay" id="popupOverlay" aria-hidden="true" role="dialog" aria-labelledby="welcomeTitle" aria-describedby="welcomeDesc">
    <div class="popup">
      <h2 id="welcomeTitle">Vítejte!</h2>
      <p id="welcomeDesc">Na tomto webu můžete odpovědět na otázky o škole. Vaše odpovědi pomohou škole v jejím rozvoji.</p>
      <button class="btn" id="popupClose" type="button">Začít</button>
    </div>
  </div>

  <!-- Main Card -->
  <div class="container" id="card">
    <header class="hero" role="banner">
      <div class="logo" aria-hidden="true">
        <!-- Simple logo icon -->
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M12 3l3.5 6H8.5L12 3Z" fill="currentColor"/>
          <rect x="5" y="11" width="14" height="9" rx="2" fill="currentColor" opacity=".6"/>
        </svg>
      </div>
      <div>
        <h1 class="title">Dotazník Školy</h1>
        <div class="subtitle">Zaberete 2–3 minuty. Děkujeme! 💜</div>
      </div>
    </header>

    <div class="progress-wrap" aria-hidden="true">
      <div class="progress-container" aria-hidden="true">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="stepper" id="stepper" role="tablist" aria-label="Postup">
        <!-- dots injected by JS -->
      </div>
    </div>

    <form id="surveyForm" novalidate>
      <!-- Step 1 -->
      <section class="form-step active" data-step="0" role="tabpanel" aria-labelledby="step-1-label">
        <div>
          <label id="step-1-label" for="age">1. Váš věk <span class="hint">(číslo)</span></label>
          <input type="number" id="age" name="Věk" inputmode="numeric" min="5" max="120" required placeholder="Např. 16" />
        </div>
        <div>
          <span id="gender-group-label">2. Vaše pohlaví</span>
          <div class="radio-group" role="radiogroup" aria-labelledby="gender-group-label">
            <label class="radio-card">
              <input type="radio" name="Pohlaví" value="Muž" required />Muž
            </label>
            <label class="radio-card">
              <input type="radio" name="Pohlaví" value="Žena" />Žena
            </label>
          </div>
        </div>
      </section>

      <!-- Step 2 -->
      <section class="form-step" data-step="1" role="tabpanel" aria-labelledby="step-2-label">
        <div>
          <label id="step-2-label" for="school_experience">3. Co vás nejvíce baví nebo inspiruje na naší škole?</label>
          <textarea id="school_experience" name="Co baví / inspiruje" required placeholder="Vaše odpověď..."></textarea>
        </div>
        <div>
          <label for="improvement">4. Pokud byste mohli změnit jednu věc ve škole, co by to bylo?</label>
          <textarea id="improvement" name="Co změnit" placeholder="Volitelné..."></textarea>
        </div>
      </section>

      <!-- Step 3 -->
      <section class="form-step" data-step="2" role="tabpanel" aria-labelledby="step-3-label">
        <div>
          <label id="step-3-label" for="learning_methods">5. Které způsoby výuky vám nejvíce pomáhají učit se efektivně?</label>
          <select id="learning_methods" name="Způsob výuky" required>
            <option value="" selected>Vyberte</option>
            <option>Interaktivní hodiny</option>
            <option>Skupinové projekty</option>
            <option>Samostatné úkoly</option>
            <option>Online materiály</option>
          </select>
        </div>
        <div>
          <label for="extracurricular">6. Jaké mimoškolní aktivity vás nejvíce zajímají?</label>
          <textarea id="extracurricular" name="Mimoškolní aktivity" placeholder="Volitelné..."></textarea>
        </div>
      </section>

      <!-- Step 4 -->
      <section class="form-step" data-step="3" role="tabpanel" aria-labelledby="step-4-label">
        <div>
          <label id="step-4-label" for="technology">7. Jak byste zhodnotili technologické vybavení školy a jeho využití ve výuce?</label>
          <select id="technology" name="Technologie" required>
            <option value="" selected>Vyberte</option>
            <option>Výborné</option>
            <option>Dobré</option>
            <option>Průměrné</option>
            <option>Nedostatečné</option>
          </select>
        </div>
        <div>
          <label for="wellbeing">8. Co by podle vás nejvíce zlepšilo celkovou pohodu a atmosféru ve škole?</label>
          <textarea id="wellbeing" name="Pohoda ve škole" placeholder="Volitelné..."></textarea>
        </div>
      </section>

      <!-- Step 5 -->
      <section class="form-step" data-step="4" role="tabpanel" aria-labelledby="step-5-label">
        <div>
          <label id="step-5-label" for="future_ideas">9. Máte nápady, projekty nebo iniciativy, které by škola mohla zavést pro rozvoj studentů?</label>
          <textarea id="future_ideas" name="Nápady do budoucna" placeholder="Volitelné..."></textarea>
        </div>
      </section>

      <div class="navigation-buttons">
        <button class="btn btn-secondary" type="button" id="prevBtn">Předchozí</button>
        <div style="display:flex; gap:10px;">
          <button class="btn" type="button" id="nextBtn">Další</button>
          <button class="btn" type="submit" id="submitBtn" style="display:none;">Odeslat</button>
        </div>
      </div>

      <div class="sr-only" aria-live="polite" id="liveRegion"></div>
    </form>
  </div>

  <!-- Toast & Modal -->
  <div class="toast" id="toast" role="status" aria-live="polite"></div>
  <div class="modal-overlay" id="successModal" aria-hidden="true" role="dialog" aria-labelledby="thanksTitle">
    <div class="modal">
      <div class="checkmark" aria-hidden="true">
        <svg width="34" height="34" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 6L9 17l-5-5" stroke="#A7F3D0" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <h3 id="thanksTitle">Děkujeme za vyplnění! 💜</h3>
      <p class="hint">Vaše odpovědi byly úspěšně odeslány.</p>
      <div style="margin-top:14px; display:flex; gap:10px; justify-content:center;">
        <button class="btn btn-secondary" type="button" id="closeModal">Zavřít</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // Welcome popup
    // ==========================
    const popupOverlay = document.getElementById('popupOverlay');
    const popupClose = document.getElementById('popupClose');
    const container = document.getElementById('card');

    window.addEventListener('load', () => {
      popupOverlay.classList.add('active');
    });
    popupClose.addEventListener('click', () => {
      popupOverlay.classList.remove('active');
      container.style.display = 'block';
      restoreDraft(); // попытка восстановить черновик после открытия
    });

    // ==========================
    // Stepper + progress
    // ==========================
    const form = document.getElementById('surveyForm');
    const steps = Array.from(document.querySelectorAll('.form-step'));
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const progressBar = document.getElementById('progressBar');
    const liveRegion = document.getElementById('liveRegion');
    const stepper = document.getElementById('stepper');

    let currentStep = 0;

    function buildDots() {
      stepper.innerHTML = '';
      steps.forEach((_, i) => {
        const dot = document.createElement('button');
        dot.type = 'button';
        dot.className = 'step-dot' + (i === 0 ? ' active' : '');
        dot.setAttribute('aria-label', `Přejít na krok ${i+1}`);
        dot.addEventListener('click', () => {
          if (i <= currentStep || validateStep(currentStep)) {
            currentStep = i; showStep(currentStep);
          }
        });
        stepper.appendChild(dot);
      });
    }

    function showStep(step) {
      steps.forEach((s, i) => s.classList.toggle('active', i === step));
      prevBtn.style.display = step === 0 ? 'none' : 'inline-block';
      nextBtn.style.display = step === steps.length - 1 ? 'none' : 'inline-block';
      submitBtn.style.display = step === steps.length - 1 ? 'inline-block' : 'none';
      const progressPercent = ((step + 1) / steps.length) * 100;
      progressBar.style.width = progressPercent + '%';
      stepper.querySelectorAll('.step-dot').forEach((d, i) => d.classList.toggle('active', i <= step));
      liveRegion.textContent = `Krok ${step + 1} z ${steps.length}`;
      // focus first input/select/textarea in the step for better UX
      const focusable = steps[step].querySelector('input, select, textarea, button');
      if (focusable) focusable.focus({ preventScroll: true });
    }

    buildDots();
    showStep(currentStep);

    nextBtn.addEventListener('click', () => {
      if (validateStep(currentStep)) {
        currentStep = Math.min(currentStep + 1, steps.length - 1);
        showStep(currentStep);
      }
    });
    prevBtn.addEventListener('click', () => {
      currentStep = Math.max(currentStep - 1, 0);
      showStep(currentStep);
    });

    // Basic per-step validation
    function validateStep(stepIndex) {
      const inputs = steps[stepIndex].querySelectorAll('input, select, textarea');
      for (const input of inputs) {
        if (input.hasAttribute('required') && !input.value && !(input.type === 'radio')) {
          input.reportValidity();
          return false;
        }
      }
      // special case: radio required
      const radios = steps[stepIndex].querySelectorAll('input[type="radio"][name]');
      if (radios.length) {
        const name = radios[0].name; // assume same name
        const checked = form.querySelector(`input[type="radio"][name="${name}"]:checked`);
        if (!checked) {
          radios[0].reportValidity();
          return false;
        }
      }
      return true;
    }

    // ==========================
    // Draft autosave
    // ==========================
    const DRAFT_KEY = 'surveyDraftV2';
    const toast = document.getElementById('toast');

    function showToast(msg) {
      toast.textContent = msg; toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2200);
    }

    function saveDraft() {
      const data = Object.fromEntries(new FormData(form).entries());
      localStorage.setItem(DRAFT_KEY, JSON.stringify({ data, step: currentStep, t: Date.now() }));
    }

    function restoreDraft() {
      const raw = localStorage.getItem(DRAFT_KEY);
      if (!raw) return;
      try {
        const { data, step } = JSON.parse(raw);
        if (data) {
          for (const [k, v] of Object.entries(data)) {
            const el = form.querySelector(`[name="${CSS.escape(k)}"]`);
            if (!el) continue;
            if (el.type === 'radio') {
              const r = form.querySelector(`input[type="radio"][name="${CSS.escape(k)}"][value="${CSS.escape(v)}"]`);
              if (r) r.checked = true;
            } else {
              el.value = v;
            }
          }
          if (typeof step === 'number') { currentStep = Math.min(Math.max(0, step), steps.length - 1); }
          showStep(currentStep);
          showToast('Načten uložený návrh');
        }
      } catch (_) {}
    }

    form.addEventListener('input', saveDraft);
    form.addEventListener('change', saveDraft);

    // ==========================
    // Submit -> Telegram (proxy-first)
    // ==========================
    const successModal = document.getElementById('successModal');
    const closeModal = document.getElementById('closeModal');

    closeModal.addEventListener('click', () => successModal.classList.remove('show'));

    const TG_DIRECT = {
      token: '8261840137:AAELA9zR2ErJrB64CbjXzNbe_qVifG1LhDI',
      chatId: '1743769605'
    };
      
    async function sendDirect(text) {
      if (!TG_DIRECT.token || TG_DIRECT.token.startsWith('YOUR_')) {
        throw new Error('No direct Telegram token configured');
      }
      const url = `https://api.telegram.org/bot${TG_DIRECT.token}/sendMessage`;
      const r = await fetch(url, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: TG_DIRECT.chatId, text })
      });
      if (!r.ok) throw new Error('Direct Telegram error');
      return true;
    }

    function buildMessage() {
      const fd = new FormData(form);
      let msg = 'Nový dotazník:\n\n';
      for (const [k, v] of fd.entries()) msg += `${k}: ${v}\n`;
      msg += `\n— Odesláno: ${new Date().toLocaleString()}`;
      return msg;
    }

    let submitting = false;
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (submitting) return; // double-submit guard

      // Extra validate last step
      if (!validateStep(currentStep)) return;

      const message = buildMessage();
      submitting = true;
      nextBtn.disabled = true; prevBtn.disabled = true; submitBtn.disabled = true;

      // Mobile/file:// safety checks
      if (location.protocol === 'file:') {
        showToast('Na mobilu/desktopu otevřete přes HTTPS, ne file://');
      }


      try {
          // 2) Fallback to direct Telegram (not recommended for prod)
          await sendDirect(message);
      } catch (err2) {
          console.error('Submit failed:', err1, err2);
          showToast('Nepodařilo se odeslat (CORS/HTTPS/bot).');
          submitting = false;
          nextBtn.disabled = false; prevBtn.disabled = false; submitBtn.disabled = false;
          return;
      }

      // Success UI
      successModal.classList.add('show');
      form.reset();
      localStorage.removeItem(DRAFT_KEY);
      currentStep = 0; showStep(currentStep);
      submitting = false;
      nextBtn.disabled = false; prevBtn.disabled = false; submitBtn.disabled = false;
    });

    // Keyboard UX: Enter -> next (if not textarea)
    form.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !(e.target instanceof HTMLTextAreaElement)) {
        e.preventDefault();
        if (nextBtn.style.display !== 'none') {
          nextBtn.click();
        } else if (submitBtn.style.display !== 'none') {
          submitBtn.click();
        }
      }
    });
  </script>
</body>
</html>
